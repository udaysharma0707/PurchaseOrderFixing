<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoices | Tile & Sanitaryware Inventory</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  
  <!-- html2canvas for invoice sharing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  
  <style>

/* HAMBURGER BUTTON - ALWAYS VISIBLE */
.sidebar-toggle-btn {
  position: fixed;
  top: 15px;
  left: 15px;
  width: 50px;
  height: 50px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  border-radius: 10px;
  color: white;
  font-size: 24px;
  cursor: pointer;
  z-index: 1100; /* HIGHER than navbar and sidebar */
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.sidebar-toggle-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
}

.sidebar-toggle-btn:active {
  transform: scale(0.95);
}

/* SIDEBAR MENU */
.sidebar-menu {
  position: fixed;
  left: -280px;
  top: 0;
  width: 280px;
  height: 100vh;
  background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
  box-shadow: 2px 0 15px rgba(0, 0, 0, 0.3);
  z-index: 1050; /* Below hamburger button */
  transition: left 0.3s ease;
  overflow-y: auto;
}

.sidebar-menu.open {
  left: 0;
}

/* SIDEBAR HEADER */
.sidebar-header {
  padding: 25px 20px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  text-align: center;
  color: white;
}

.sidebar-header h4 {
  margin: 10px 0 0 0;
  font-size: 18px;
  font-weight: 600;
}

/* SIDEBAR SECTION TITLE */
.sidebar-section-title {
  padding: 15px 20px 8px 20px;
  font-size: 11px;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.5);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* SIDEBAR ITEM */
.sidebar-item {
  display: flex;
  align-items: center;
  padding: 14px 20px;
  color: rgba(255, 255, 255, 0.9);
  text-decoration: none;
  transition: all 0.2s ease;
  cursor: pointer;
}

.sidebar-item:hover {
  background: rgba(255, 255, 255, 0.1);
  color: white;
}

.sidebar-item i {
  font-size: 18px;
  margin-right: 15px;
  width: 20px;
  text-align: center;
}

.sidebar-item span {
  font-size: 14px;
  font-weight: 500;
}

.sidebar-item.active {
  background: rgba(255, 255, 255, 0.15);
  color: white;
  border-left: 4px solid #4CAF50;
}

/* SIDEBAR OVERLAY */
.sidebar-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1040; /* Below sidebar */
  display: none;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.sidebar-overlay.show {
  display: block;
  opacity: 1;
}



    /* ================================================
       INVOICES PAGE - EMBEDDED CSS
       ================================================ */
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f8f9fa;
      overflow-x: hidden;
    }
    
    
    
    /* ========== MAIN CONTAINER ========== */
    .container-fluid {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }
    
    /* ========== EMPTY STATE ========== */
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: #6c757d;
    }
    
    .empty-state i {
      font-size: 80px;
      color: #dee2e6;
      margin-bottom: 20px;
    }
    
    .empty-state h3 {
      margin-bottom: 10px;
      color: #495057;
    }
    
    .empty-state p {
      margin-bottom: 30px;
    }
    
    /* ========== INVOICES GRID ========== */
    .invoices-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 24px;
      margin-top: 20px;
    }
    
    /* ========== INVOICE CARD ========== */
    .invoice-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid #e9ecef;
      position: relative;
      overflow: hidden;
    }
    
    .invoice-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .invoice-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.12);
      border-color: #667eea;
    }
    
    .invoice-card:hover::before {
      opacity: 1;
    }
    
    .invoice-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e9ecef;
    }
    
    .invoice-number {
      font-size: 1.1rem;
      font-weight: 700;
      color: #495057;
      font-family: 'Courier New', monospace;
    }
    
    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-paid {
      background: #d4edda;
      color: #155724;
    }
    
    .status-unpaid {
      background: #fff3cd;
      color: #856404;
    }
    
    .status-overdue {
      background: #f8d7da;
      color: #721c24;
    }
    
    .invoice-card-body {
      margin-bottom: 20px;
    }
    
    .invoice-card-body h5 {
      font-size: 1.25rem;
      font-weight: 600;
      color: #212529;
      margin-bottom: 12px;
    }
    
    .invoice-date {
      color: #6c757d;
      font-size: 0.9rem;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .invoice-amount {
      font-size: 1.5rem;
      font-weight: 700;
      color: #28a745;
      margin: 12px 0 0 0;
    }
    
    .invoice-card-footer {
      display: flex;
      gap: 8px;
      padding-top: 16px;
      border-top: 1px solid #e9ecef;
    }
    
    .btn-icon {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      color: #495057;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 4px;
      flex: 1;
      justify-content: center;
    }
    
    .btn-icon:hover {
      background: #e9ecef;
      transform: translateY(-2px);
    }
    
    .btn-icon i {
      font-size: 1rem;
    }
    
    .btn-icon.btn-edit:hover {
      background: #007bff;
      color: white;
      border-color: #007bff;
    }
    
    .btn-icon.btn-share:hover {
      background: #17a2b8;
      color: white;
      border-color: #17a2b8;
    }
    
    .btn-icon.btn-delete:hover {
      background: #dc3545;
      color: white;
      border-color: #dc3545;
    }

    .hover-shadow {
  transition: all 0.3s ease;
}

.hover-shadow:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2) !important;
}

    
    /* ========== RESPONSIVE ========== */
    @media (max-width: 768px) {
      .invoice-header {
        flex-direction: column;
        gap: 15px;
        padding: 15px;
      }
      
      .invoice-header h1 {
        font-size: 1.2rem;
      }
      
      .invoices-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .back-btn, .create-btn {
        width: 100%;
        justify-content: center;
      }
    }
    .toast-container {
  position: fixed;
  top: 80px;
  right: 20px;
  z-index: 9999;
}

.custom-toast {
  min-width: 300px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  padding: 16px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 12px;
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.toast-success { border-left: 4px solid #28a745; }
.toast-danger { border-left: 4px solid #dc3545; }
.toast-warning { border-left: 4px solid #ffc107; }
.toast-info { border-left: 4px solid #17a2b8; }

    

  </style>
</head>
  
<body>
   <!-- HAMBURGER BUTTON (FIXED POSITION - ALWAYS VISIBLE) -->
  <button class="sidebar-toggle-btn" onclick="toggleSidebar()">
    <i class="bi bi-list"></i>
  </button>

  <!-- SIDEBAR OVERLAY -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<!-- SIDEBAR MENU - CORRECTED LINKS -->
<nav class="sidebar-menu" id="sidebarMenu">
  <!-- Sidebar Header -->
  <div class="sidebar-header">
    <i class="bi bi-boxes" style="font-size: 32px;"></i>
    <h4>Menu</h4>
  </div>

  <!-- HOME -->
  <a href="index.html" class="sidebar-item">
    <i class="bi bi-house-door"></i>
    <span>Home</span>
  </a>

  <!-- GENERAL Section -->
  <div class="sidebar-section-title">GENERAL</div>
  
<!-- All Products -->
<div class="sidebar-item" onclick="goToAllProducts()">
  <i class="bi bi-box"></i>
  <span>All Products</span>
</div>
  
<!-- Products in Group -->
<div class="sidebar-item" onclick="goToProductGroups()">
  <i class="bi bi-collection"></i>
  <span>Products in Group</span>
</div>

<!-- CUSTOMERS Section -->
<div class="sidebar-section-title">CUSTOMERS</div>

<!-- Customers -->
<div class="sidebar-item" onclick="goToCustomers()">
  <i class="bi bi-people"></i>
  <span>Customers</span>
</div>

  <!-- SALES Section -->
  <div class="sidebar-section-title">SALES</div>
  
  <!-- INVOICES - Current page (active) -->
  <a href="invoices.html" class="sidebar-item active">
    <i class="bi bi-receipt"></i>
    <span>Invoices</span>
  </a>
  <div class="sidebar-item" onclick="goToPurchaseOrders()">
  🛒 Purchase Orders
</div>

  
  <!-- DISABLED OPTIONS - Coming Soon -->
  <div class="sidebar-item disabled" style="opacity: 0.5; cursor: not-allowed;">
    <i class="bi bi-cash-stack"></i>
    <span>Sales Receipts</span>
  </div>
  
  <div class="sidebar-item disabled" style="opacity: 0.5; cursor: not-allowed;">
    <i class="bi bi-cart-check"></i>
    <span>Sales Order</span>
  </div>

  <!-- REPORTS Section -->
  <div class="sidebar-section-title">REPORTS</div>
  
  <div class="sidebar-item disabled" style="opacity: 0.5; cursor: not-allowed;">
    <i class="bi bi-graph-up"></i>
    <span>Sales Report</span>
  </div>

  <!-- SETTINGS Section -->
  <div class="sidebar-section-title">SETTINGS</div>
  
  <div class="sidebar-item disabled" style="opacity: 0.5; cursor: not-allowed;">
    <i class="bi bi-gear"></i>
    <span>Settings</span>
  </div>
</nav>


  <!-- Navigation Bar (Top Header) -->
  <nav class="navbar navbar-expand-lg navbar-dark sticky-top" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding-left: 70px;">
    <div class="container-fluid px-3">
      <!-- Back Button -->
      <a href="index.html" class="btn btn-light btn-sm me-2">
        <i class="bi bi-arrow-left"></i> Back
      </a>
      
      <!-- Page Title -->
      <h5 class="navbar-brand mb-0 text-white d-none d-md-block">
        <i class="bi bi-receipt"></i> Invoices
      </h5>
      
      <!-- Create Button (Desktop) -->
      <button class="btn btn-success d-none d-lg-block ms-auto" onclick="openCreateInvoiceModal()">
        <i class="bi bi-plus-circle"></i> Create Invoice
      </button>
      
      <!-- Collapsible Menu (Mobile) -->
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto mt-3 mt-lg-0">
          <li class="nav-item">
            <a class="nav-link" href="index.html">
              <i class="bi bi-house-door"></i> Home
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="invoices.html">
              <i class="bi bi-receipt"></i> Invoices
            </a>
          </li>
          <!-- Create Button (Mobile Only) -->
          <li class="nav-item d-lg-none mt-2">
            <button class="btn btn-success w-100" onclick="openCreateInvoiceModal()">
              <i class="bi bi-plus-circle"></i> Create Invoice
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

 

<!-- ========================================
     MAIN CONTAINER - INVOICES LIST
     ======================================== -->
<div class="container-fluid">
  <div id="invoicesContainer">
    <!-- JavaScript will populate this -->
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3 text-muted">Loading invoices...</p>
    </div>
  </div>
</div>


  <!-- ========================================
       INVOICE VIEW MODAL (For viewing full invoice)
       ======================================== -->
  <div class="modal fade" id="invoiceViewModal" tabindex="-1" aria-labelledby="invoiceViewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-fullscreen-md-down">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="invoiceViewModalLabel">
            <i class="bi bi-receipt"></i> Invoice Details
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="invoiceViewContent">
          <!-- Invoice preview will be rendered here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="editCurrentInvoice()">
            <i class="bi bi-pencil"></i> Edit
          </button>
          <button type="button" class="btn btn-success" onclick="shareCurrentInvoice()">
            <i class="bi bi-share"></i> Share
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ========================================
       INVOICE CREATE/EDIT MODAL
       ======================================== -->
  <div class="modal fade" id="invoiceModal" tabindex="-1" aria-labelledby="invoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="invoiceModalLabel">
            <i class="bi bi-receipt"></i> <span id="invoiceModalTitle">Create Invoice</span>
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        
        <div class="modal-body">
          <form id="invoiceForm">
            
            <!-- Customer Name -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="invoiceCustomerName" class="form-label">Customer Name *</label>
                <input type="text" class="form-control" id="invoiceCustomerName" required>
              </div>
              
              <div class="col-md-6">
                <label for="invoiceNumber" class="form-label">Invoice Number *</label>
                <input type="text" class="form-control" id="invoiceNumber" required>
              </div>
            </div>
            
            <!-- Dates -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="invoiceDate" class="form-label">Invoice Date *</label>
                <input type="date" class="form-control" id="invoiceDate" required>
              </div>
              
              <div class="col-md-6">
                <label for="invoiceDueDate" class="form-label">Due Date *</label>
                <input type="date" class="form-control" id="invoiceDueDate" required>
              </div>
            </div>
            
            <!-- Items Section -->
            <div class="mb-3">
              <label class="form-label fw-bold">Invoice Items</label>
              <div id="invoiceItemsContainer">
                <!-- Items will be added here -->
              </div>
              <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addInvoiceItem()">
                <i class="bi bi-plus-circle"></i> Add Item
              </button>
            </div>
            
            <!-- Total -->
            <div class="row">
              <div class="col-md-8"></div>
              <div class="col-md-4">
                <div class="card bg-light">
                  <div class="card-body">
                    <h5 class="mb-0">Total: ₹<span id="invoiceTotal">0.00</span></h5>
                  </div>
                </div>
              </div>
            </div>
            
          </form>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveInvoice()">
            <i class="bi bi-save"></i> Save Invoice
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- =====================================================
     EDIT INVOICE MODAL
     ===================================================== -->

<div id="editInvoiceModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; overflow-y: auto;">
  <div class="modal-content" style="background: white; margin: 2rem auto; border-radius: 8px; max-width: 600px; width: 95%;">
    
    <!-- Modal Header -->
    <div class="modal-header" style="background: #0066cc; color: white; padding: 20px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;">
      <h2 style="margin: 0;">Edit Invoice</h2>
      <button onclick="closeEditInvoiceModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">×</button>
    </div>
    
    <!-- Modal Body -->
    <div class="modal-body" style="padding: 20px;">
      
      <!-- Customer Name (Read-only) -->
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Customer Name</label>
        <input type="text" id="editCustomerName" readonly style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5;">
      </div>
      
      <!-- Invoice Number (Read-only) -->
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Invoice Number</label>
        <input type="text" id="editInvoiceNumber" readonly style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5;">
      </div>
      
      <!-- Invoice Date (Read-only) -->
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Invoice Date</label>
        <input type="date" id="editInvoiceDate" readonly style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5;">
      </div>
      
      <!-- Due Date (Read-only) -->
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Due Date</label>
        <input type="date" id="editDueDate" readonly style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5;">
      </div>
      
      <!-- Invoice Items Section -->
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 10px; font-weight: bold;">Invoice Items</label>
        <div id="editInvoiceItemsContainer" style="border: 1px solid #ddd; border-radius: 4px; padding: 10px; background: #f9f9f9;">
          <!-- Items will be populated here -->
        </div>
      </div>
      
      <!-- Total Amount (Read-only) -->
      <div style="margin-bottom: 15px; background: #e8f4f8; padding: 15px; border-radius: 4px;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Total Amount</label>
        <div id="editTotalAmount" style="font-size: 20px; color: #009900; font-weight: bold;">₹0.00</div>
      </div>
      
    </div>
    
    <!-- Modal Footer -->
    <div class="modal-footer" style="padding: 20px; border-top: 1px solid #ddd; display: flex; gap: 10px; justify-content: flex-end;">
      <button onclick="closeEditInvoiceModal()" class="btn" style="background: #ddd; color: black; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Cancel</button>
      <button onclick="saveEditedInvoice()" class="btn-primary" style="background: #0066cc; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Update Invoice</button>
    </div>
    
  </div>
</div>




 <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    
   
 // ========================================
    // CONFIGURATION - GOOGLE SHEETS API
    // Check both localStorage and sessionStorage
    // ========================================
    
   const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby2b6vbz_92rrEPLlDuMV99HMLN7iWrmqjAu7k8l13gzHqIsnrybt8ybKnJiBl0-tWbZQ/exec';
    
    console.log('✅ Invoices page loaded');
    
    // Global variables
    let currentEditingIndex = null;
    let currentViewingIndex = null;
    let invoiceItemCounter = 0;


    /**
   * ==========================================
   * SIDEBAR FUNCTIONS
   * ==========================================
   */
  function toggleSidebar() {
    const sidebar = document.getElementById('sidebarMenu');
    const overlay = document.getElementById('sidebarOverlay');
    
    sidebar.classList.toggle('open');
    overlay.classList.toggle('show');
  }

  function closeSidebar() {
    const sidebar = document.getElementById('sidebarMenu');
    const overlay = document.getElementById('sidebarOverlay');
    
    sidebar.classList.remove('open');
    overlay.classList.remove('show');
  }

  // Auto-close sidebar when clicking any link
  document.addEventListener('DOMContentLoaded', () => {
    const sidebarLinks = document.querySelectorAll('.sidebar-item:not(.disabled)');
    sidebarLinks.forEach(link => {
      link.addEventListener('click', () => {
        closeSidebar();
      });
    });
  });

  // For disabled menu items
  function sidebarAction(action) {
    console.log('Sidebar action:', action);
    alert(action.replace(/([A-Z])/g, ' $1').trim() + ' feature coming soon!');
    closeSidebar();
  } 

   
function goToAllProducts() {
  // Close sidebar
  if (typeof closeSidebar === 'function') {
    closeSidebar();
  }
  
  // Navigate to index.html with query parameter
  window.location.href = 'index.html?page=allProducts';
}

    // Navigate to Product Groups page
function goToProductGroups() {
  console.log('🔗 goToProductGroups called from invoices');
  if (typeof closeSidebar === 'function') {
    closeSidebar();
  }
  window.location.href = 'index.html?page=productGroups';
}

// Navigate to Customers page
function goToCustomers() {
  console.log('🔗 goToCustomers called from invoices');
  if (typeof closeSidebar === 'function') {
    closeSidebar();
  }
  window.location.href = 'index.html?page=customers';
}
    /**
 * ==========================================
 * DATE FORMATTING UTILITIES
 * ==========================================
 */

// Convert any date format to YYYY-MM-DD for date input
function formatDateForInput(dateStr) {
  if (!dateStr) return '';
  
  try {
    // Handle ISO timestamp (2025-10-28T18:30:00.000Z)
    if (dateStr.includes('T')) {
      const date = new Date(dateStr);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    // If already in YYYY-MM-DD format
    if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
      return dateStr;
    }
    
    // If in DD-MM-YYYY format
    if (/^\d{2}-\d{2}-\d{4}$/.test(dateStr)) {
      const [day, month, year] = dateStr.split('-');
      return `${year}-${month}-${day}`;
    }
    
    // If in DD/MM/YYYY format
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) {
      const [day, month, year] = dateStr.split('/');
      return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
    }
    
    return dateStr;
  } catch (error) {
    console.error('Error formatting date for input:', error);
    return '';
  }
}

// Convert any date format to readable display (DD MMM YYYY)
function formatDateForDisplay(dateStr) {
  if (!dateStr) return 'N/A';
  
  try {
    let date;
    
    // Handle ISO timestamp (2025-10-28T18:30:00.000Z)
    if (dateStr.includes('T') || dateStr.includes('Z')) {
      date = new Date(dateStr);
    } 
    // Handle YYYY-MM-DD
    else if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
      date = new Date(dateStr + 'T00:00:00');
    }
    // Handle DD-MM-YYYY
    else if (/^\d{2}-\d{2}-\d{4}$/.test(dateStr)) {
      const [day, month, year] = dateStr.split('-');
      date = new Date(`${year}-${month}-${day}T00:00:00`);
    }
    // Handle DD/MM/YYYY
    else if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) {
      const [day, month, year] = dateStr.split('/');
      date = new Date(`${year}-${month}-${day}T00:00:00`);
    }
    else {
      return dateStr; // Return as-is if unknown format
    }
    
    // Format as DD MMM YYYY (e.g., 29 Oct 2025)
    const day = date.getDate();
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const month = months[date.getMonth()];
    const year = date.getFullYear();
    
    return `${day} ${month} ${year}`;
  } catch (error) {
    console.error('Error formatting date for display:', error);
    return dateStr;
  }
}

// Get simple YYYY-MM-DD format
function getSimpleDateString(dateStr) {
  if (!dateStr) return '';
  
  try {
    if (dateStr.includes('T') || dateStr.includes('Z')) {
      const date = new Date(dateStr);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
      return dateStr;
    }
    
    return formatDateForInput(dateStr);
  } catch (error) {
    console.error('Error getting simple date string:', error);
    return dateStr;
  }
}

    /* ========================================
       1. PAGE INITIALIZATION
       ======================================== */
 document.addEventListener('DOMContentLoaded', function() {
  console.log('📄 Invoices page loaded');
  
  // Check if invoicesContainer exists before loading
  const container = document.getElementById('invoicesContainer');
  if (container) {
    console.log('✅ invoicesContainer found, loading invoices...');
    loadInvoices();
  } else {
    console.error('❌ ERROR: invoicesContainer element not found in HTML!');
    console.error('Please make sure <div id="invoicesContainer"></div> exists in the body');
  }
  
  // Set default dates for invoice form
  setDefaultDates();
});

    
    
/* ========================================
   LOAD INVOICES FROM GOOGLE SHEETS
   ======================================== */

async function loadInvoices() {
  console.log('📊 Loading invoices from Google Sheets...');
  
  const container = document.getElementById('invoicesContainer');
  
  // Show loading
  container.innerHTML = `
    <div class="loading-state">
      <div class="spinner-border text-primary"></div>
      <p>Loading invoices...</p>
    </div>
  `;
  
  try {
    // ✅ POST REQUEST (not GET)
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',  // ← CRITICAL!
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: new URLSearchParams({
        action: 'getInvoices'
      })
    });
    
    const data = await response.json();
    console.log('📥 Response:', data);
    
    if (!data.success) {
      throw new Error(data.error || 'Failed to load invoices');
    }
    
    const invoices = data.invoices || [];
    console.log(`✅ Loaded ${invoices.length} invoices`);
    
    if (invoices.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="bi bi-inbox"></i>
          <h3>No Invoices Yet</h3>
          <p>Click "Create Invoice" to add your first invoice</p>
        </div>
      `;
      return;
    }
    
    // Display invoices (you need displayInvoices function)
    displayInvoices(invoices);
    
  } catch (error) {
    console.error('❌ Error loading invoices:', error);
    container.innerHTML = `
      <div class="empty-state">
        <i class="bi bi-exclamation-triangle text-danger"></i>
        <h3>Error Loading Invoices</h3>
        <p>${error.message}</p>
        <button class="btn btn-primary" onclick="loadInvoices()">
          <i class="bi bi-arrow-clockwise"></i> Retry
        </button>
      </div>
    `;
  }
}

/**
 * ==========================================
 * DISPLAY INVOICES FUNCTION
 * ==========================================
 */
function displayInvoices(invoices) {
  console.log('📊 Displaying', invoices.length, 'invoices');
  
  const container = document.getElementById('invoicesContainer');
  
  if (!invoices || invoices.length === 0) {
    container.innerHTML = `
      <div class="text-center py-5">
        <i class="bi bi-inbox" style="font-size: 80px; color: #dee2e6;"></i>
        <h3 class="mt-3">No Invoices Yet</h3>
        <p class="text-muted">Click "Create Invoice" to add your first invoice</p>
        <button class="btn btn-success mt-3" onclick="openCreateInvoiceModal()">
          <i class="bi bi-plus-circle"></i> Create First Invoice
        </button>
      </div>
    `;
    return;
  }
  
  // Store invoices globally for quick access
  window.invoicesCache = invoices;
  
  let html = '<div class="row g-4">';
  
  invoices.forEach(invoice => {
    const statusClass = invoice.status === 'paid' ? 'bg-success' : 
                        invoice.status === 'unpaid' ? 'bg-warning' : 
                        'bg-danger';
    
    const statusText = invoice.status || 'unpaid';
    
    // ✅ CLEAN DATE FORMATTING
    const cleanInvoiceDate = formatDateForDisplay(invoice.invoiceDate);
    const cleanDueDate = formatDateForDisplay(invoice.dueDate);
    
    html += `
      <div class="col-12 col-md-6 col-lg-4">
        <div class="card h-100 shadow-sm hover-shadow" 
             style="transition: all 0.3s ease; cursor: pointer;" 
             id="invoice-card-${invoice.invoiceId}"
             onclick="viewInvoiceDetails('${invoice.invoiceId}')">
          <div class="card-body">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
              <h6 class="mb-0 font-monospace fw-bold">${invoice.invoiceNumber || 'N/A'}</h6>
              <span class="badge ${statusClass} text-white" id="status-badge-${invoice.invoiceId}">${statusText.toUpperCase()}</span>
            </div>
            
            <!-- Customer Name -->
            <h5 class="card-title mb-3" id="customer-${invoice.invoiceId}">${invoice.customerName || 'Unknown Customer'}</h5>
            
            <!-- Invoice Date -->
            <div class="text-muted small mb-2" id="date-${invoice.invoiceId}">
              <i class="bi bi-calendar3"></i> 
              ${cleanInvoiceDate}
            </div>
            
            <!-- Due Date -->
            <div class="text-muted small mb-3" id="due-${invoice.invoiceId}">
              <i class="bi bi-calendar-check"></i> 
              Due: ${cleanDueDate}
            </div>
            
            <!-- Total Amount -->
            <h4 class="text-success mb-0 fw-bold" id="total-${invoice.invoiceId}">
              ₹${parseFloat(invoice.total || 0).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
            </h4>
          </div>
          
          <!-- Action Buttons -->
          <div class="card-footer bg-white border-top">
            <div class="d-flex gap-2">
             <button class="btn btn-sm btn-outline-primary flex-fill" onclick="event.stopPropagation(); openEditInvoice('${invoice.invoiceId}')">
  <i class="bi bi-pencil"></i> Edit
</button>

              <button class="btn btn-sm btn-outline-info flex-fill" onclick="event.stopPropagation(); viewInvoiceDetails('${invoice.invoiceId}')">
                <i class="bi bi-eye"></i> View
              </button>
              <button class="btn btn-sm btn-outline-danger flex-fill" onclick="event.stopPropagation(); deleteInvoicePrompt('${invoice.invoiceId}')">
                <i class="bi bi-trash"></i> Delete
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  container.innerHTML = html;
  console.log('✅ Invoices displayed successfully');
}



/**
 * ==========================================
 * INVOICE ACTION FUNCTIONS
 * ==========================================
 */
/**
 * ==========================================
 * VIEW INVOICE - OPEN IN NEW TAB/WINDOW
 * ==========================================
 */
function viewInvoiceDetails(invoiceId) {
  console.log('👁️ Viewing invoice:', invoiceId);
  
  const invoice = window.invoicesCache?.find(inv => inv.invoiceId === invoiceId);
  
  if (!invoice) {
    alert('Invoice not found');
    return;
  }
  
  console.log('📄 Invoice data:', invoice);
  
  // Parse items if stored as JSON string
  let items = [];
  if (invoice.items) {
    try {
      items = typeof invoice.items === 'string' ? JSON.parse(invoice.items) : invoice.items;
      console.log('📦 Parsed items:', items);
    } catch (e) {
      console.error('Error parsing items:', e);
      console.log('Raw items data:', invoice.items);
      items = [];
    }
  }
  
  // ✅ USE VALUES FROM SHEET OR CALCULATE FROM ITEMS
  let subtotal = parseFloat(invoice.subtotal) || 0;
  let discount = parseFloat(invoice.discount) || 0;
  let tax = parseFloat(invoice.tax) || 0;
  let grandTotal = parseFloat(invoice.total) || 0;
  
  // If no subtotal in sheet, calculate from items
  if (subtotal === 0 && items.length > 0) {
    subtotal = items.reduce((sum, item) => {
      const amount = parseFloat(item.amount) || parseFloat(item.total) || (parseFloat(item.quantity) * parseFloat(item.rate));
      return sum + amount;
    }, 0);
  }
  
  // If no grand total in sheet, calculate it
  if (grandTotal === 0) {
    grandTotal = subtotal - discount + tax;
  }
  
  console.log('💰 Totals - Subtotal:', subtotal, 'Discount:', discount, 'Tax:', tax, 'Grand Total:', grandTotal);
  
  // Generate invoice HTML
  const invoiceHTML = generateInvoiceHTML(invoice, items, subtotal, discount, tax, grandTotal);
  
  // Open in new window
  const printWindow = window.open('', '_blank', 'width=800,height=600');
  printWindow.document.write(invoiceHTML);
  printWindow.document.close();
}


/**
 * ==========================================
 * GENERATE INVOICE HTML - FIXED AMOUNT CALCULATION
 * ==========================================
 */
function generateInvoiceHTML(invoice, items, subtotal, discount, tax, grandTotal) {
  const cleanInvoiceDate = formatDateForDisplay(invoice.invoiceDate);
  const cleanDueDate = formatDateForDisplay(invoice.dueDate);
  
  let itemsHTML = '';
  
  if (items && items.length > 0) {
    items.forEach((item, index) => {
      // Handle different field name variations
      const description = item.description || item.name || item.itemName || item.product || 'Item';
      const quantity = parseFloat(item.quantity || item.qty || 1);
      const rate = parseFloat(item.rate || item.price || item.unitPrice || 0);
      
      // ✅ CALCULATE AMOUNT: If amount field exists use it, otherwise calculate qty * rate
      let amount = parseFloat(item.amount || item.total || 0);
      if (amount === 0) {
        amount = quantity * rate;
      }
      
      console.log(`Item ${index + 1}:`, { description, quantity, rate, amount });
      
      itemsHTML += `
        <tr>
          <td style="padding: 12px; border-bottom: 1px solid #e0e0e0; text-align: center;">${index + 1}</td>
          <td style="padding: 12px; border-bottom: 1px solid #e0e0e0;">${description}</td>
          <td style="padding: 12px; border-bottom: 1px solid #e0e0e0; text-align: center;">${quantity}</td>
          <td style="padding: 12px; border-bottom: 1px solid #e0e0e0; text-align: right;">₹${rate.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
          <td style="padding: 12px; border-bottom: 1px solid #e0e0e0; text-align: right;">₹${amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
        </tr>
      `;
    });
  } else {
    // If no items, show a placeholder row
    itemsHTML = `
      <tr>
        <td colspan="5" style="padding: 20px; text-align: center; color: #999;">
          No items available
        </td>
      </tr>
    `;
  }
  
  // ... rest of the HTML generation (keep everything else the same)
  return `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice ${invoice.invoiceNumber}</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 40px;
      background: #f5f5f5;
    }
    
    .invoice-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 40px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    
    .invoice-header {
      text-align: center;
      margin-bottom: 40px;
      border-bottom: 3px solid #2c3e50;
      padding-bottom: 20px;
    }
    
    .invoice-header h1 {
      font-size: 36px;
      color: #2c3e50;
      margin-bottom: 10px;
    }
    
    .company-name {
      font-size: 20px;
      color: #7f8c8d;
      font-weight: bold;
    }
    
    .invoice-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 40px;
    }
    
    .detail-group h3 {
      color: #2c3e50;
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 8px;
    }
    
    .detail-group p {
      color: #34495e;
      font-size: 16px;
      line-height: 1.6;
    }
    
    .items-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }
    
    .items-table thead {
      background: #34495e;
      color: white;
    }
    
    .items-table th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
    }
    
    .items-table th:first-child,
    .items-table td:first-child {
      text-align: center;
    }
    
    .items-table th:nth-child(3),
    .items-table td:nth-child(3) {
      text-align: center;
    }
    
    .items-table th:nth-child(4),
    .items-table th:nth-child(5),
    .items-table td:nth-child(4),
    .items-table td:nth-child(5) {
      text-align: right;
    }
    
    .totals-section {
      float: right;
      width: 350px;
      margin-bottom: 40px;
    }
    
    .totals-section table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .totals-section td {
      padding: 10px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .totals-section td:first-child {
      text-align: left;
      font-weight: 500;
    }
    
    .totals-section td:last-child {
      text-align: right;
    }
    
    .totals-section .grand-total {
      background: #34495e;
      color: white;
      font-weight: bold;
      font-size: 18px;
    }
    
    .footer-section {
      clear: both;
      margin-top: 60px;
      padding-top: 20px;
      border-top: 2px solid #e0e0e0;
    }
    
    .footer-section h3 {
      color: #2c3e50;
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .footer-section p,
    .footer-section ol {
      color: #7f8c8d;
      font-size: 13px;
      line-height: 1.8;
    }
    
    .footer-section ol {
      margin-left: 20px;
    }
    
    @media print {
      body {
        background: white;
        padding: 0;
      }
      
      .invoice-container {
        box-shadow: none;
        padding: 20px;
      }
      
      .no-print {
        display: none;
      }
    }
    
    .print-buttons {
      text-align: center;
      margin-top: 30px;
    }
    
    .print-buttons button {
      padding: 12px 30px;
      margin: 0 10px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .print-btn {
      background: #3498db;
      color: white;
    }
    
    .print-btn:hover {
      background: #2980b9;
    }
    
    .close-btn {
      background: #95a5a6;
      color: white;
    }
    
    .close-btn:hover {
      background: #7f8c8d;
    }
  </style>
</head>
<body>
  <div class="invoice-container">
    <!-- Header -->
    <div class="invoice-header">
      <h1>INVOICE</h1>
      <p class="company-name">Tile & Sanitaryware Inventory</p>
    </div>
    
    <!-- Invoice Details -->
    <div class="invoice-details">
      <div>
        <div class="detail-group">
          <h3>Invoice Number:</h3>
          <p><strong>${invoice.invoiceNumber}</strong></p>
        </div>
        <div class="detail-group" style="margin-top: 20px;">
          <h3>Customer Name:</h3>
          <p>${invoice.customerName}</p>
        </div>
      </div>
      <div>
        <div class="detail-group">
          <h3>Invoice Date:</h3>
          <p>${cleanInvoiceDate}</p>
        </div>
        <div class="detail-group" style="margin-top: 20px;">
          <h3>Due Date:</h3>
          <p>${cleanDueDate}</p>
        </div>
      </div>
    </div>
    
    <!-- Items Table -->
    <table class="items-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Item Description</th>
          <th>Quantity</th>
          <th>Rate</th>
          <th>Amount</th>
        </tr>
      </thead>
      <tbody>
        ${itemsHTML}
      </tbody>
    </table>
    
    <!-- Totals -->
    <div class="totals-section">
      <table>
        <tr>
          <td>Sub Total:</td>
          <td>₹${subtotal.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
        </tr>
        <tr>
          <td>Discount:</td>
          <td>-₹${discount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
        </tr>
        <tr>
          <td>Tax:</td>
          <td>₹${tax.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
        </tr>
        <tr class="grand-total">
          <td>Grand Total:</td>
          <td>₹${grandTotal.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
        </tr>
      </table>
    </div>
    
    <!-- Footer -->
    <div class="footer-section">
      <div style="margin-bottom: 20px;">
        <h3>Customer Notes:</h3>
        <p>Thanks for your business.</p>
      </div>
      
      <div>
        <h3>Terms & Conditions:</h3>
        <ol>
          <li>Payment due within 14 days of invoice date</li>
          <li>Late payments subject to 2% monthly interest charge</li>
          <li>Goods once sold cannot be returned or exchanged</li>
        </ol>
      </div>
    </div>
    
    <!-- Print Buttons -->
    <div class="print-buttons no-print">
      <button class="print-btn" onclick="window.print()">
        🖨️ Print Invoice
      </button>
      <button class="close-btn" onclick="window.close()">
        ✕ Close
      </button>
    </div>
  </div>
</body>
</html>
  `;
}


/**
 * Open Edit Invoice Modal
 * Load existing invoice data and display items
 */
function openEditInvoiceModal(invoiceId) {
  console.log('📝 Opening Edit Invoice Modal for:', invoiceId);
  
  // Get invoice data from Google Sheets or storage
  const invoice = allInvoices.find(inv => inv.id === invoiceId);
  
  if (!invoice) {
    console.error('❌ Invoice not found:', invoiceId);
    return;
  }
  
  // === POPULATE FORM WITH EXISTING DATA ===
  document.getElementById('editCustomerName').value = invoice.customerName || '';
  document.getElementById('editInvoiceNumber').value = invoice.invoiceNumber || '';
  document.getElementById('editInvoiceDate').value = invoice.invoiceDate || '';
  document.getElementById('editDueDate').value = invoice.dueDate || '';
  
  // === DISPLAY INVOICE ITEMS ===
  const itemsContainer = document.getElementById('editInvoiceItemsContainer');
  itemsContainer.innerHTML = '';
  
  if (invoice.items && invoice.items.length > 0) {
    invoice.items.forEach((item, index) => {
      const itemHTML = `
        <div style="background: white; padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ddd;">
          <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 10px; align-items: center;">
            <div>
              <strong>Description:</strong> ${item.description || '-'}
            </div>
            <div>
              <strong>Qty:</strong> ${item.quantity || 0}
            </div>
            <div>
              <strong>Rate:</strong> ₹${item.rate || 0}
            </div>
            <div>
              <strong>Amount:</strong> ₹${item.amount || 0}
            </div>
            <button onclick="removeInvoiceItem(${index})" style="background: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Delete</button>
          </div>
        </div>
      `;
      itemsContainer.innerHTML += itemHTML;
    });
  } else {
    itemsContainer.innerHTML = '<p style="text-align: center; color: #999;">No items found</p>';
  }
  
  // === UPDATE TOTAL AMOUNT ===
  const total = invoice.items ? invoice.items.reduce((sum, item) => sum + (item.amount || 0), 0) : 0;
  document.getElementById('editTotalAmount').textContent = `₹${total.toFixed(2)}`;
  
  // Store current invoice ID for later use
  window.currentEditInvoiceId = invoiceId;
  
  // === SHOW MODAL ===
  document.getElementById('editInvoiceModal').style.display = 'block';
  console.log('✅ Edit Invoice Modal opened');
}

/**
 * Close Edit Invoice Modal
 */
function closeEditInvoiceModal() {
  console.log('❌ Closing Edit Invoice Modal');
  document.getElementById('editInvoiceModal').style.display = 'none';
  window.currentEditInvoiceId = null;
}

/**
 * Remove Item from Edit View
 */
function removeInvoiceItem(itemIndex) {
  console.log('🗑️ Removing item at index:', itemIndex);
  
  if (!window.currentEditInvoiceId) {
    console.error('❌ No invoice ID in context');
    return;
  }
  
  // Find and update the invoice
  const invoice = allInvoices.find(inv => inv.id === window.currentEditInvoiceId);
  if (invoice && invoice.items) {
    invoice.items.splice(itemIndex, 1);
    
    // Refresh the modal display
    openEditInvoiceModal(window.currentEditInvoiceId);
    console.log('✅ Item removed successfully');
  }
}

/**
 * Save Edited Invoice
 */
function saveEditedInvoice() {
  console.log('💾 Saving Edited Invoice:', window.currentEditInvoiceId);
  
  if (!window.currentEditInvoiceId) {
    console.error('❌ No invoice ID in context');
    return;
  }
  
  // Find the invoice
  const invoice = allInvoices.find(inv => inv.id === window.currentEditInvoiceId);
  if (!invoice) {
    console.error('❌ Invoice not found');
    return;
  }
  
  // Call your existing update function to save to Google Sheets
  if (typeof updateInvoiceInGoogleSheets === 'function') {
    updateInvoiceInGoogleSheets(invoice);
  } else {
    console.warn('⚠️ updateInvoiceInGoogleSheets function not found');
  }
  
  closeEditInvoiceModal();
  console.log('✅ Invoice saved successfully');
}

/**
 * ==========================================
 * EDIT INVOICE FUNCTION
 * ==========================================
 */

async function editInvoice(invoiceId) {
  console.log('✏️ Editing invoice:', invoiceId);
  
  // Get invoice from cache
  const invoice = window.invoicesCache?.find(inv => inv.invoiceId === invoiceId);
  
  if (!invoice) {
    alert('Invoice not found. Please refresh the page.');
    return;
  }
  
  console.log('📋 Original invoice data:', invoice);
  
  // ✅ FORMAT DATES PROPERLY FOR DATE INPUT (uses global helper function)
  const formattedInvoiceDate = formatDateForInput(invoice.invoiceDate);
  const formattedDueDate = formatDateForInput(invoice.dueDate);
  
  console.log('📅 Formatted dates - Invoice:', formattedInvoiceDate, 'Due:', formattedDueDate);
  
  // Populate form
  document.getElementById('editInvoiceId').value = invoice.invoiceId;
  document.getElementById('editInvoiceNumber').value = invoice.invoiceNumber || '';
  document.getElementById('editCustomerName').value = invoice.customerName || '';
  document.getElementById('editInvoiceDate').value = formattedInvoiceDate;
  document.getElementById('editDueDate').value = formattedDueDate;
  document.getElementById('editTotal').value = invoice.total || 0;
  document.getElementById('editStatus').value = invoice.status || 'unpaid';
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('editInvoiceModal'));
  modal.show();
}
/**
 * ==========================================
 * SAVE EDITED INVOICE - WITH OPTIMISTIC UPDATE
 * ==========================================
 */
async function saveEditedInvoice() {
  console.log('💾 Saving edited invoice...');
  
  const invoiceId = document.getElementById('editInvoiceId').value;
  const invoiceNumber = document.getElementById('editInvoiceNumber').value;
  const customerName = document.getElementById('editCustomerName').value;
  const invoiceDate = document.getElementById('editInvoiceDate').value;
  const dueDate = document.getElementById('editDueDate').value;
  const total = parseFloat(document.getElementById('editTotal').value);
  const status = document.getElementById('editStatus').value;
  
  if (!customerName || !invoiceDate || !dueDate || !total) {
    alert('Please fill in all required fields');
    return;
  }
  
  // ✅ STEP 1: INSTANT UI UPDATE (before backend call)
  const statusClass = status === 'paid' ? 'bg-success' : 
                      status === 'unpaid' ? 'bg-warning' : 'bg-danger';
  
  // ✅ FORMAT DATES FOR DISPLAY
  const displayInvoiceDate = formatDateForDisplay(invoiceDate);
  const displayDueDate = formatDateForDisplay(dueDate);
  
  // Update the card immediately
  document.getElementById(`status-badge-${invoiceId}`).className = `badge ${statusClass} text-white`;
  document.getElementById(`status-badge-${invoiceId}`).textContent = status.toUpperCase();
  document.getElementById(`customer-${invoiceId}`).textContent = customerName;
  document.getElementById(`date-${invoiceId}`).innerHTML = `<i class="bi bi-calendar3"></i> ${displayInvoiceDate}`;
  document.getElementById(`due-${invoiceId}`).innerHTML = `<i class="bi bi-calendar-check"></i> Due: ${displayDueDate}`;
  document.getElementById(`total-${invoiceId}`).textContent = `₹${total.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
  
  // Update cache
  const cachedInvoice = window.invoicesCache?.find(inv => inv.invoiceId === invoiceId);
  if (cachedInvoice) {
    cachedInvoice.invoiceNumber = invoiceNumber;
    cachedInvoice.customerName = customerName;
    cachedInvoice.invoiceDate = invoiceDate;
    cachedInvoice.dueDate = dueDate;
    cachedInvoice.total = total;
    cachedInvoice.status = status;
  }
  
  // ✅ STEP 2: CLOSE MODAL IMMEDIATELY
  const modal = bootstrap.Modal.getInstance(document.getElementById('editInvoiceModal'));
  modal.hide();
  
  // ✅ STEP 3: SHOW SUCCESS MESSAGE IMMEDIATELY
  showToast('✅ Invoice updated successfully!', 'success');
  
  // ✅ STEP 4: UPDATE BACKEND IN BACKGROUND
  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: new URLSearchParams({
        action: 'updateInvoice',
        invoiceId: invoiceId,
        invoiceNumber: invoiceNumber,
        customerName: customerName,
        invoiceDate: invoiceDate,
        dueDate: dueDate,
        total: total,
        status: status
      })
    });
    
    const data = await response.json();
    console.log('✅ Backend update response:', data);
    
    if (!data.success) {
      // If backend fails, revert UI and show error
      showToast('⚠️ Failed to sync with server. Refreshing...', 'warning');
      setTimeout(() => loadInvoices(), 1000);
    }
  } catch (error) {
    console.error('❌ Error updating invoice:', error);
    showToast('⚠️ Network error. Changes may not be saved.', 'danger');
  }
}



    
function shareInvoice(invoiceId) {
  console.log('📤 Sharing invoice:', invoiceId);
  alert('Share invoice: ' + invoiceId);
  // TODO: Implement invoice share
}

function deleteInvoicePrompt(invoiceId) {
  console.log('🗑️ Delete invoice:', invoiceId);
  if (confirm('Are you sure you want to delete this invoice?')) {
    deleteInvoiceById(invoiceId);
  }
}

async function deleteInvoiceById(invoiceId) {
  console.log('🗑️ Deleting invoice:', invoiceId);
  
  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: new URLSearchParams({
        action: 'deleteInvoice',
        invoiceId: invoiceId
      })
    });
    
    const data = await response.json();
    console.log('Delete response:', data);
    
    if (data.success) {
      alert('Invoice deleted successfully!');
      loadInvoices(); // Reload invoices
    } else {
      throw new Error(data.error || 'Failed to delete invoice');
    }
  } catch (error) {
    console.error('❌ Error deleting invoice:', error);
    alert('Error deleting invoice: ' + error.message);
  }
}

    
    
   /* ========================================
   3. RENDER SINGLE INVOICE CARD - UPDATED FOR GOOGLE SHEETS
   ======================================== */

function renderInvoiceCard(invoice, index) {
  const status = getInvoiceStatus(invoice);
  const statusClass = getStatusClass(status);
  const formattedDate = formatDate(invoice.invoiceDate);
  const total = invoice.total || calculateTotal(invoice.items || []);
  
  // Use invoiceId instead of index for tracking
  const invoiceId = invoice.invoiceId || invoice.invoiceNumber || index;
  
  return `
    <div class="invoice-card" onclick="openInvoiceView('${invoiceId}')" data-invoice-id="${invoiceId}">
      <div class="invoice-card-header">
        <span class="invoice-number">${escapeHtml(invoice.invoiceNumber || 'N/A')}</span>
        <span class="status-badge ${statusClass}">${status}</span>
      </div>
      
      <div class="invoice-card-body">
        <h5>${escapeHtml(invoice.customerName || 'Unknown Customer')}</h5>
        <p class="invoice-date">
          <i class="bi bi-calendar"></i> ${formattedDate}
        </p>
        <p class="invoice-amount">₹${total.toFixed(2)}</p>
      </div>
      
      <div class="invoice-card-footer">
        <button class="btn-icon btn-edit" onclick="event.stopPropagation(); openEditInvoice('${invoiceId}')" title="Edit">
          <i class="bi bi-pencil"></i> Edit
        </button>
        <button class="btn-icon btn-share" onclick="event.stopPropagation(); shareInvoice('${invoiceId}')" title="Share">
          <i class="bi bi-share"></i> Share
        </button>
        <button class="btn-icon btn-delete" onclick="event.stopPropagation(); deleteInvoice('${invoiceId}')" title="Delete">
          <i class="bi bi-trash"></i> Delete
        </button>
      </div>
    </div>
  `;
}

    /* ========================================
       4. INVOICE STATUS HELPERS
       ======================================== */
    
    function getInvoiceStatus(invoice) {
      if (!invoice.dueDate) return 'Unpaid';
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const dueDate = new Date(invoice.dueDate);
      dueDate.setHours(0, 0, 0, 0);
      
      if (invoice.paid) return 'Paid';
      if (dueDate < today) return 'Overdue';
      return 'Unpaid';
    }
    
    function getStatusClass(status) {
      switch(status) {
        case 'Paid': return 'status-paid';
        case 'Overdue': return 'status-overdue';
        case 'Unpaid': return 'status-unpaid';
        default: return 'status-unpaid';
      }
    }
    
  
 /* ========================================
   5. OPEN INVOICE VIEW - UPDATED FOR GOOGLE SHEETS
   ======================================== */

async function openInvoiceView(invoiceId) {
  console.log('👁️ Opening invoice view:', invoiceId);
  
  try {
    // Show loading in modal
    document.getElementById('invoiceViewContent').innerHTML = `
      <div class="text-center py-5">
        <div class="spinner-border text-primary"></div>
        <p class="mt-3">Loading invoice...</p>
      </div>
    `;
    
    // Open modal immediately
    const modal = new bootstrap.Modal(document.getElementById('invoiceViewModal'));
    modal.show();
    
    // Fetch invoice from Google Sheets
    const url = `${SCRIPT_URL}?action=getInvoice&invoiceId=${encodeURIComponent(invoiceId)}`;
    const response = await fetch(url);
    const data = await response.json();
    
    if (!data.success || !data.invoice) {
      throw new Error(data.error || 'Invoice not found');
    }
    
    const invoice = data.invoice;
    currentViewingIndex = invoiceId;
    
    // Generate invoice preview HTML
    const invoiceHTML = generateInvoiceViewHTML(invoice);
    
    // Display in modal
    document.getElementById('invoiceViewContent').innerHTML = invoiceHTML;
    document.getElementById('invoiceViewModalLabel').innerHTML = 
      `<i class="bi bi-receipt"></i> Invoice ${escapeHtml(invoice.invoiceNumber || 'N/A')}`;
    
  } catch (error) {
    console.error('❌ Error opening invoice:', error);
    document.getElementById('invoiceViewContent').innerHTML = `
      <div class="text-center py-5">
        <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
        <h4 class="mt-3">Error Loading Invoice</h4>
        <p>${escapeHtml(error.message)}</p>
        <button class="btn btn-primary" onclick="openInvoiceView('${invoiceId}')">
          <i class="bi bi-arrow-clockwise"></i> Retry
        </button>
      </div>
    `;
  }
}

    
    /* ========================================
       6. GENERATE INVOICE VIEW HTML
       ======================================== */
    
    function generateInvoiceViewHTML(invoice) {
      const items = invoice.items || [];
      const total = invoice.total || calculateTotal(items);
      
      let itemsHTML = '';
      items.forEach((item, idx) => {
        const itemTotal = (item.quantity || 0) * (item.rate || 0);
        itemsHTML += `
          <tr>
            <td>${idx + 1}</td>
            <td>${escapeHtml(item.description || 'N/A')}</td>
            <td>${item.quantity || 0}</td>
            <td>₹${(item.rate || 0).toFixed(2)}</td>
            <td>₹${itemTotal.toFixed(2)}</td>
          </tr>
        `;
      });
      
      return `
        <div class="invoice-preview" style="max-width: 800px; margin: 0 auto; padding: 20px; background: white;">
          <div style="text-align: center; margin-bottom: 30px;">
            <h2 style="color: #667eea; margin-bottom: 5px;">TAX INVOICE</h2>
            <p style="color: #6c757d; margin: 0;">Tile & Sanitaryware Inventory</p>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
            <div>
              <p style="margin: 5px 0;"><strong>Customer:</strong> ${escapeHtml(invoice.customerName || 'N/A')}</p>
              <p style="margin: 5px 0;"><strong>Invoice #:</strong> ${escapeHtml(invoice.invoiceNumber || 'N/A')}</p>
            </div>
            <div style="text-align: right;">
              <p style="margin: 5px 0;"><strong>Invoice Date:</strong> ${formatDate(invoice.invoiceDate)}</p>
              <p style="margin: 5px 0;"><strong>Due Date:</strong> ${formatDate(invoice.dueDate)}</p>
            </div>
          </div>
          
          <table class="table table-bordered">
            <thead style="background: #f8f9fa;">
              <tr>
                <th style="width: 50px;">#</th>
                <th>Description</th>
                <th style="width: 100px;">Qty</th>
                <th style="width: 120px;">Rate</th>
                <th style="width: 120px;">Amount</th>
              </tr>
            </thead>
            <tbody>
              ${itemsHTML}
            </tbody>
            <tfoot>
              <tr>
                <td colspan="4" style="text-align: right; font-weight: bold;">Total</td>
                <td style="font-weight: bold;">₹${total.toFixed(2)}</td>
              </tr>
            </tfoot>
          </table>
          
          <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #dee2e6; text-align: center; color: #6c757d;">
            <p>Thank you for your business!</p>
          </div>
        </div>
      `;
    }
    
    /* ========================================
       7. OPEN CREATE INVOICE MODAL
       ======================================== */
    
    function openCreateInvoiceModal() {
      console.log('➕ Opening create invoice modal');
      
      // Reset form
      currentEditingIndex = null;
      document.getElementById('invoiceForm').reset();
      document.getElementById('invoiceModalTitle').textContent = 'Create Invoice';
      
      // Generate new invoice number
      const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
      const newInvoiceNumber = generateInvoiceNumber(invoices.length);
      document.getElementById('invoiceNumber').value = newInvoiceNumber;
      
      // Set default dates
      setDefaultDates();
      
      // Clear items and add one empty item
      document.getElementById('invoiceItemsContainer').innerHTML = '';
      invoiceItemCounter = 0;
      addInvoiceItem();
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('invoiceModal'));
      modal.show();
    }
    
   /* ========================================
   8. OPEN EDIT INVOICE - UPDATED FOR GOOGLE SHEETS
   ======================================== */

/**
 * OPEN EDIT INVOICE - SHOWS EXISTING ITEMS
 */
/**
 * OPEN EDIT INVOICE - Load from window.invoicesCache
 */
function openEditInvoice(invoiceId) {
  console.log('📝 Opening edit invoice:', invoiceId);
  
  try {
    // Find invoice in window.invoicesCache (not allInvoices!)
    const invoice = window.invoicesCache?.find(inv => inv.invoiceId === invoiceId);
    
    if (!invoice) {
      console.error('❌ Invoice not found in invoicesCache');
      alert('Invoice not found');
      return;
    }
    
    console.log('✅ Found invoice:', invoice);
    
    currentEditingIndex = invoiceId;
    
    // === UPDATE MODAL TITLE ===
    document.getElementById('invoiceModalTitle').textContent = '✏️ Edit Invoice';
    
    // === POPULATE FORM WITH EXISTING DATA ===
    document.getElementById('invoiceCustomerName').value = invoice.customerName || '';
    document.getElementById('invoiceNumber').value = invoice.invoiceNumber || '';
    document.getElementById('invoiceDate').value = formatDateForInput(invoice.invoiceDate) || '';
    document.getElementById('invoiceDueDate').value = formatDateForInput(invoice.dueDate) || '';
    
    // === POPULATE ITEMS ===
    document.getElementById('invoiceItemsContainer').innerHTML = '';
    invoiceItemCounter = 0;
    
    // Parse items if they're stored as JSON string
    let items = invoice.items;
    if (typeof items === 'string') {
      try {
        items = JSON.parse(items);
      } catch (e) {
        console.error('Error parsing items:', e);
        items = [];
      }
    }
    
    if (items && items.length > 0) {
      console.log('📦 Loading', items.length, 'items');
      items.forEach(item => {
        addInvoiceItem(item);
      });
    } else {
      // Add one empty item if no items exist
      addInvoiceItem();
    }
    
    // Calculate total
    calculateInvoiceTotal();
    
    // === SHOW MODAL ===
    const modal = new bootstrap.Modal(document.getElementById('invoiceModal'));
    modal.show();
    
    console.log('✅ Edit invoice modal opened successfully');
    
  } catch (error) {
    console.error('❌ Error opening edit invoice:', error);
    alert('Error: ' + error.message);
  }
}


    
    /* ========================================
       9. ADD INVOICE ITEM ROW
       ======================================== */
    
    function addInvoiceItem(item = null) {
      invoiceItemCounter++;
      const itemId = `item-${invoiceItemCounter}`;
      
      const itemHTML = `
        <div class="invoice-item mb-2" id="${itemId}">
          <div class="row g-2">
            <div class="col-md-4">
              <input type="text" class="form-control" placeholder="Description" 
                     value="${item ? escapeHtml(item.description || '') : ''}"
                     onchange="calculateInvoiceTotal()">
            </div>
            <div class="col-md-2">
              <input type="number" class="form-control" placeholder="Quantity" min="1"
                     value="${item ? (item.quantity || 1) : 1}"
                     onchange="calculateInvoiceTotal()">
            </div>
            <div class="col-md-2">
              <input type="number" class="form-control" placeholder="Rate" min="0" step="0.01"
                     value="${item ? (item.rate || 0) : 0}"
                     onchange="calculateInvoiceTotal()">
            </div>
            <div class="col-md-3">
              <input type="text" class="form-control" placeholder="Amount" readonly
                     value="0.00">
            </div>
            <div class="col-md-1">
              <button type="button" class="btn btn-danger btn-sm w-100" onclick="removeInvoiceItem('${itemId}')">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('invoiceItemsContainer').insertAdjacentHTML('beforeend', itemHTML);
      calculateInvoiceTotal();
    }
    
    /* ========================================
       10. REMOVE INVOICE ITEM
       ======================================== */
    
    function removeInvoiceItem(itemId) {
      const itemElement = document.getElementById(itemId);
      if (itemElement) {
        itemElement.remove();
        calculateInvoiceTotal();
      }
    }
    
    /* ========================================
       11. CALCULATE INVOICE TOTAL
       ======================================== */
    
    function calculateInvoiceTotal() {
      const items = document.querySelectorAll('.invoice-item');
      let total = 0;
      
      items.forEach(item => {
        const inputs = item.querySelectorAll('input');
        const quantity = parseFloat(inputs[1].value) || 0;
        const rate = parseFloat(inputs[2].value) || 0;
        const amount = quantity * rate;
        
        inputs[3].value = amount.toFixed(2);
        total += amount;
      });
      
      document.getElementById('invoiceTotal').textContent = total.toFixed(2);
    }
    
  /* ========================================
   12. SAVE INVOICE - UPDATED FOR GOOGLE SHEETS
   ======================================== */

/* ========================================
   12. SAVE INVOICE - SIMPLIFIED (NO AUTH)
   ======================================== */

async function saveInvoice() {
  console.log('💾 Saving invoice...');
  
  // Validate form
  const customerName = document.getElementById('invoiceCustomerName').value.trim();
  const invoiceNumber = document.getElementById('invoiceNumber').value.trim();
  const invoiceDate = document.getElementById('invoiceDate').value;
  const dueDate = document.getElementById('invoiceDueDate').value;
  
  if (!customerName) {
    alert('❌ Please enter customer name');
    return;
  }
  
  if (!invoiceNumber) {
    alert('❌ Please enter invoice number');
    return;
  }
  
  if (!invoiceDate) {
    alert('❌ Please select invoice date');
    return;
  }
  
  if (!dueDate) {
    alert('❌ Please select due date');
    return;
  }
  
  // Collect items
  const items = collectInvoiceItems();
  
  if (items.length === 0) {
    alert('❌ Please add at least one item');
    return;
  }
  
  const total = calculateTotal(items);
  
  // Show saving indicator
  const saveBtn = event.target;
  const originalText = saveBtn.innerHTML;
  saveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
  saveBtn.disabled = true;
  
  try {
    // Check script URL
    if (!SCRIPT_URL) {
      throw new Error('Script URL not configured. Please check settings.');
    }
    
    // Prepare data - NO EMAIL/HASH NEEDED
    const formData = new FormData();
    formData.append('action', currentEditingIndex ? 'updateInvoice' : 'saveInvoice');
    formData.append('customerName', customerName);
    formData.append('invoiceNumber', invoiceNumber);
    formData.append('invoiceDate', invoiceDate);
    formData.append('dueDate', dueDate);
    formData.append('items', JSON.stringify(items));
    formData.append('subtotal', total);
    formData.append('tax', 0);
    formData.append('total', total);
    formData.append('status', 'unpaid');
    
    if (currentEditingIndex) {
      formData.append('invoiceId', currentEditingIndex);
    }
    
    console.log('📤 Sending invoice to Google Sheets...');
    
    // Send to Google Sheets
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: formData
    });
    
    const responseText = await response.text();
    console.log('📥 Response:', responseText);
    
    let data;
    try {
      data = JSON.parse(responseText);
    } catch (parseError) {
      console.error('❌ Failed to parse response:', responseText);
      throw new Error('Invalid response from server');
    }
    
    if (!data.success) {
      throw new Error(data.error || data.message || 'Failed to save invoice');
    }
    
    console.log('✅ Invoice saved successfully');
    alert(currentEditingIndex ? '✅ Invoice updated successfully!' : '✅ Invoice created successfully!');
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('invoiceModal'));
    modal.hide();
    
    // Reload invoices list
    await loadInvoices();
    
    // Reset editing index
    currentEditingIndex = null;
    
  } catch (error) {
    console.error('❌ Error saving invoice:', error);
    alert('❌ Error: ' + error.message);
    
    // Restore button
    saveBtn.innerHTML = originalText;
    saveBtn.disabled = false;
  }
}


    
    /* ========================================
       13. COLLECT INVOICE ITEMS FROM FORM
       ======================================== */
    
    function collectInvoiceItems() {
      const items = [];
      const itemElements = document.querySelectorAll('.invoice-item');
      
      itemElements.forEach(item => {
        const inputs = item.querySelectorAll('input');
        const description = inputs[0].value.trim();
        const quantity = parseFloat(inputs[1].value) || 0;
        const rate = parseFloat(inputs[2].value) || 0;
        
        if (description && quantity > 0 && rate > 0) {
          items.push({
            description: description,
            quantity: quantity,
            rate: rate
          });
        }
      });
      
      return items;
    }
    
 /* ========================================
   14. DELETE INVOICE - SIMPLIFIED (NO AUTH)
   ======================================== */

async function deleteInvoice(invoiceId) {
  if (!confirm('⚠️ Are you sure you want to delete this invoice? This action cannot be undone.')) {
    return;
  }
  
  console.log('🗑️ Deleting invoice:', invoiceId);
  
  try {
    // NO EMAIL/HASH NEEDED
    const formData = new FormData();
    formData.append('action', 'deleteInvoice');
    formData.append('invoiceId', invoiceId);
    
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    
    if (!data.success) {
      throw new Error(data.error || 'Failed to delete invoice');
    }
    
    console.log('✅ Invoice deleted successfully');
    alert('✅ Invoice deleted successfully');
    
    // Reload invoices
    await loadInvoices();
    
  } catch (error) {
    console.error('❌ Error deleting invoice:', error);
    alert('❌ Error: ' + error.message);
  }
}

    
   /* ========================================
   15. SHARE INVOICE - UPDATED FOR GOOGLE SHEETS
   ======================================== */

async function shareInvoice(invoiceId) {
  console.log('📤 Sharing invoice:', invoiceId);
  
  try {
    // Fetch invoice from Google Sheets
    const url = `${SCRIPT_URL}?action=getInvoice&invoiceId=${encodeURIComponent(invoiceId)}`;
    const response = await fetch(url);
    const data = await response.json();
    
    if (!data.success || !data.invoice) {
      throw new Error(data.error || 'Invoice not found');
    }
    
    const invoice = data.invoice;
    
    // Generate invoice HTML for sharing
    const invoiceHTML = generateInvoiceViewHTML(invoice);
    
    // Create temporary container
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = invoiceHTML;
    tempDiv.style.position = 'absolute';
    tempDiv.style.left = '-9999px';
    document.body.appendChild(tempDiv);
    
    // Convert to canvas using html2canvas
    const canvas = await html2canvas(tempDiv.querySelector('.invoice-preview'), {
      scale: 2,
      logging: false,
      useCORS: true
    });
    
    // Convert canvas to blob
    canvas.toBlob(async (blob) => {
      const file = new File([blob], `Invoice-${invoice.invoiceNumber}.png`, { type: 'image/png' });
      
      // Check if Web Share API is available
      if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({
            title: `Invoice ${invoice.invoiceNumber}`,
            text: `Invoice for ${invoice.customerName}`,
            files: [file]
          });
          console.log('✅ Invoice shared successfully');
        } catch (err) {
          if (err.name !== 'AbortError') {
            console.error('Share failed:', err);
            downloadInvoiceImage(canvas, invoice.invoiceNumber);
          }
        }
      } else {
        // Fallback: Download image
        downloadInvoiceImage(canvas, invoice.invoiceNumber);
      }
      
      // Remove temporary div
      document.body.removeChild(tempDiv);
    });
    
  } catch (error) {
    console.error('Error sharing invoice:', error);
    alert('❌ Failed to share invoice: ' + error.message);
  }
}

    
    /* ========================================
       16. DOWNLOAD INVOICE AS IMAGE
       ======================================== */
    
    function downloadInvoiceImage(canvas, invoiceNumber) {
      const link = document.createElement('a');
      link.download = `Invoice-${invoiceNumber}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
      alert('✅ Invoice downloaded as image');
    }
    
    /* ========================================
       17. EDIT CURRENT INVOICE (from view modal)
       ======================================== */
    
    function editCurrentInvoice() {
      if (currentViewingIndex !== null) {
        // Close view modal
        const viewModal = bootstrap.Modal.getInstance(document.getElementById('invoiceViewModal'));
        if (viewModal) viewModal.hide();
        
        // Open edit modal
        setTimeout(() => {
          openEditInvoice(currentViewingIndex);
        }, 300);
      }
    }
    
    /* ========================================
       18. SHARE CURRENT INVOICE (from view modal)
       ======================================== */
    
    function shareCurrentInvoice() {
      if (currentViewingIndex !== null) {
        shareInvoice(currentViewingIndex);
      }
    }
    
    /* ========================================
       19. GO BACK TO DASHBOARD
       ======================================== */
    
    function goBackToDashboard() {
      console.log('🏠 Returning to dashboard');
      window.location.href = 'index.html';
    }
    
    /* ========================================
       20. HELPER: GENERATE INVOICE NUMBER
       ======================================== */
    
    function generateInvoiceNumber(count) {
      const paddedNumber = String(count + 1).padStart(6, '0');
      return `INV-${paddedNumber}`;
    }
    
    /* ========================================
       21. HELPER: FORMAT DATE
       ======================================== */
    
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return 'Invalid Date';
      
      const options = { year: 'numeric', month: 'short', day: 'numeric' };
      return date.toLocaleDateString('en-IN', options);
    }
    
    /* ========================================
       22. HELPER: SET DEFAULT DATES
       ======================================== */
    
    function setDefaultDates() {
      const today = new Date();
      const todayString = today.toISOString().split('T')[0];
      
      // Set invoice date to today
      const invoiceDateInput = document.getElementById('invoiceDate');
      if (invoiceDateInput && !invoiceDateInput.value) {
        invoiceDateInput.value = todayString;
      }
      
      // Set due date to 30 days from today
      const dueDate = new Date(today);
      dueDate.setDate(dueDate.getDate() + 30);
      const dueDateString = dueDate.toISOString().split('T')[0];
      
      const dueDateInput = document.getElementById('invoiceDueDate');
      if (dueDateInput && !dueDateInput.value) {
        dueDateInput.value = dueDateString;
      }
    }
    
    /* ========================================
       23. HELPER: CALCULATE TOTAL FROM ITEMS
       ======================================== */
    
    function calculateTotal(items) {
      if (!items || items.length === 0) return 0;
      
      return items.reduce((sum, item) => {
        const quantity = parseFloat(item.quantity) || 0;
        const rate = parseFloat(item.rate) || 0;
        return sum + (quantity * rate);
      }, 0);
    }
    
    /* ========================================
       24. HELPER: ESCAPE HTML (Security)
       ======================================== */
    
    function escapeHtml(text) {
      if (!text) return '';
      
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      
      return text.toString().replace(/[&<>"']/g, function(m) { return map[m]; });
    }
    
    /* ========================================
       25. HELPER: SAFE JSON PARSE
       ======================================== */
    
    function safeJSONParse(str, defaultValue = []) {
      try {
        return JSON.parse(str);
      } catch (e) {
        console.error('JSON parse error:', e);
        return defaultValue;
      }
    }

    /**
 * ==========================================
 * TOAST NOTIFICATION SYSTEM
 * ==========================================
 */
function showToast(message, type = 'success') {
  const container = document.getElementById('toastContainer') || createToastContainer();
  
  const toast = document.createElement('div');
  toast.className = `custom-toast toast-${type}`;
  toast.innerHTML = `
    <div style="flex: 1;">${message}</div>
    <button onclick="this.parentElement.remove()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #666;">&times;</button>
  `;
  
  container.appendChild(toast);
  
  // Auto remove after 3 seconds
  setTimeout(() => {
    toast.style.animation = 'slideIn 0.3s ease-out reverse';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function createToastContainer() {
  const container = document.createElement('div');
  container.id = 'toastContainer';
  container.className = 'toast-container';
  document.body.appendChild(container);
  return container;
}

    
// Navigate to Purchase Orders page
function goToPurchaseOrders() {
  // Close sidebar if open
  try {
    const sidebar = document.querySelector('.sidebar');
    const toggleBtn = document.querySelector('.sidebar-toggle-btn');
    if (sidebar && sidebar.classList.contains('show') && toggleBtn) {
      toggleBtn.click();
    }
  } catch(e) { /* ignore if sidebar doesn't exist */ }
  
  // Redirect to purchases page
  window.location.href = 'purchase.html';
}

    /* ========================================
   GO BACK FUNCTION
   ======================================== */
function goBack() {
  window.location.href = 'index.html';
}

  function goToHome() {
    closeSidebar();
    window.location.href = 'index.html';
  }

    
    /* ========================================
       END OF JAVASCRIPT
       ======================================== */
    
    console.log('✅ Invoices page JavaScript loaded successfully');
    
  </script>

</body>
</html>


















































